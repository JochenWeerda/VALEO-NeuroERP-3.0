name: E2E Smoke Tests

on:
  push:
    branches: [develop, main]
  pull_request:
    branches: [develop, main]
  workflow_dispatch:

jobs:
  smoke-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    strategy:
      fail-fast: false
      matrix:
        domain: [sales, agrar, crm, finance, inventory]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Install Playwright Browsers
        run: pnpm exec playwright install --with-deps chromium
      
      - name: Setup Test Environment
        run: |
          cp .env.uat .env
          echo "VALEO_TENANT=QA-UAT-01" >> .env
          echo "VALEO_BASE_URL=http://localhost:3000" >> .env
      
      - name: Build Application
        run: pnpm build
      
      - name: Start Backend (Background)
        run: |
          cd ${{ github.workspace }}
          python -m uvicorn main:app --host 0.0.0.0 --port 8000 &
          sleep 5
      
      - name: Start Frontend (Background)
        run: |
          cd packages/frontend-web
          pnpm preview --port 3000 &
          sleep 5
      
      - name: Run Smoke Tests - ${{ matrix.domain }}
        run: pnpm exec playwright test --grep "@smoke" --project=smoke specs/${{ matrix.domain }}/
        env:
          PLAYWRIGHT_RUN_ID: ${{ github.run_id }}-${{ matrix.domain }}
          BUILD_ID: ${{ github.sha }}
      
      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-artifacts-${{ matrix.domain }}-${{ github.run_id }}
          path: |
            playwright-tests/artifacts/
            playwright-report/
          retention-days: 7
      
      - name: Upload Coverage Matrix
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-matrix-${{ matrix.domain }}
          path: docs/uat/COVERAGE-MATRIX.csv
          retention-days: 30

  summary:
    runs-on: ubuntu-latest
    needs: smoke-tests
    if: always()
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: Generate Summary
        run: |
          echo "## UAT Smoke Tests Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results by Domain" >> $GITHUB_STEP_SUMMARY
          echo "- Sales: ${{ needs.smoke-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Agrar: ${{ needs.smoke-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- CRM: ${{ needs.smoke-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Finance: ${{ needs.smoke-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Inventory: ${{ needs.smoke-tests.result }}" >> $GITHUB_STEP_SUMMARY

