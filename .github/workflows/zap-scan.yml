name: OWASP ZAP Security Scan
on:
  schedule:
    - cron: "0 2 * * 0"  # Weekly scan (Sunday 02:00 UTC)
  workflow_dispatch:      # Manual trigger
  pull_request:
    branches: [main]

jobs:
  zap-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install uvicorn[standard]

      - name: Launch FastAPI test server
        run: |
          uvicorn main:app --host 0.0.0.0 --port 7070 &
          sleep 10
        env:
          JWT_SECRET: test-secret-for-ci
          OIDC_ISSUER: ""
          DEBUG: "false"

      - name: Wait for server
        run: |
          timeout 30 bash -c 'until curl -f http://localhost:7070/health; do sleep 2; done'

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: "http://localhost:7070"
          rules_file_name: ".zap/rules.tsv"
          cmd_options: "-m 3 -j"
          fail_action: false  # Don't fail build, just report

      - name: Upload ZAP report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-report-${{ github.run_number }}
          path: |
            report_html.html
            report_json.json
          retention-days: 30

      - name: Create ZAP summary
        if: always()
        run: |
          echo "## ðŸ”’ OWASP ZAP Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** http://localhost:7070" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Full report available in artifacts" >> $GITHUB_STEP_SUMMARY

