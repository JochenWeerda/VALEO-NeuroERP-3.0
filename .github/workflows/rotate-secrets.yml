name: Rotate Secrets
on:
  workflow_dispatch:
    inputs:
      rotate_jwt:
        description: 'Rotate JWT_SECRET'
        required: true
        type: boolean
        default: true
      rotate_db:
        description: 'Rotate DB_PASSWORD'
        required: true
        type: boolean
        default: false
  schedule:
    - cron: "0 0 1 * *"  # Monthly on 1st at midnight

jobs:
  rotate:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      secrets: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Generate new JWT secret
        if: ${{ inputs.rotate_jwt || github.event_name == 'schedule' }}
        run: |
          NEW_JWT=$(openssl rand -hex 32)
          echo "::add-mask::$NEW_JWT"
          echo "NEW_JWT_SECRET=$NEW_JWT" >> $GITHUB_ENV
          echo "âœ… Generated new JWT_SECRET"
      
      - name: Update JWT secret in GitHub Secrets
        if: ${{ inputs.rotate_jwt || github.event_name == 'schedule' }}
        run: |
          gh secret set JWT_SECRET --body "$NEW_JWT_SECRET"
          echo "âœ… Updated JWT_SECRET in GitHub Secrets"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Generate new DB password
        if: ${{ inputs.rotate_db }}
        run: |
          NEW_DB_PW=$(openssl rand -base64 32)
          echo "::add-mask::$NEW_DB_PW"
          echo "NEW_DB_PASSWORD=$NEW_DB_PW" >> $GITHUB_ENV
          echo "âœ… Generated new DB_PASSWORD"
      
      - name: Update DB password in GitHub Secrets
        if: ${{ inputs.rotate_db }}
        run: |
          gh secret set DB_PASSWORD --body "$NEW_DB_PASSWORD"
          echo "âœ… Updated DB_PASSWORD in GitHub Secrets"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create rotation audit log
        run: |
          mkdir -p .security-audit
          echo "$(date -u +%Y-%m-%dT%H:%M:%SZ) - Secret rotation completed" >> .security-audit/rotation-log.txt
          echo "  JWT_SECRET: ${{ inputs.rotate_jwt || 'scheduled' }}" >> .security-audit/rotation-log.txt
          echo "  DB_PASSWORD: ${{ inputs.rotate_db || 'false' }}" >> .security-audit/rotation-log.txt
      
      - name: Notify team
        run: |
          echo "ðŸ” Secret rotation completed successfully!"
          echo "Please restart services to pick up new secrets."
      
      - name: Create summary
        run: |
          echo "## ðŸ” Secret Rotation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Rotated:**" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.rotate_jwt || github.event_name == 'schedule' }}" = "true" ]; then
            echo "- âœ… JWT_SECRET" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ inputs.rotate_db }}" = "true" ]; then
            echo "- âœ… DB_PASSWORD" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Action Required:** Restart services to apply new secrets" >> $GITHUB_STEP_SUMMARY

