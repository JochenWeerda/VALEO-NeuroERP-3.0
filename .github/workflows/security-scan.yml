name: Security Scan

on:
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  owasp-zap-full-scan:
    name: OWASP ZAP Full Scan
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Start application
        run: |
          uvicorn main:app --host 0.0.0.0 --port 8000 &
          sleep 10
      
      - name: Wait for app to be ready
        run: |
          timeout 30 bash -c 'until curl -f http://localhost:8000/healthz; do sleep 2; done'
      
      - name: OWASP ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.10.0
        with:
          target: 'http://localhost:8000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j'
          allow_issue_writing: true
          fail_action: true
          issue_title: 'OWASP ZAP Full Scan Report'
      
      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-report
          path: |
            report_html.html
            report_json.json
            report_md.md
  
  trivy-scan:
    name: Trivy Container Scan
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Docker image
        run: docker build -t valeo-erp:${{ github.sha }} .
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'valeo-erp:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # Fail on high/critical
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
  
  grype-scan:
    name: Grype Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Docker image
        run: docker build -t valeo-erp:${{ github.sha }} .
      
      - name: Run Grype scan
        uses: anchore/scan-action@v3
        with:
          image: 'valeo-erp:${{ github.sha }}'
          fail-build: true
          severity-cutoff: high
      
      - name: Upload Grype results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: ${{ steps.scan.outputs.sarif }}
  
  bandit-scan:
    name: Bandit Python Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Bandit
        run: pip install bandit[toml]
      
      - name: Run Bandit scan
        run: |
          bandit -r app/ -f json -o bandit-report.json --exit-zero
          bandit -r app/ -f txt
      
      - name: Check for high severity issues
        run: |
          HIGH_COUNT=$(jq '[.results[] | select(.issue_severity == "HIGH" or .issue_severity == "CRITICAL")] | length' bandit-report.json)
          echo "High/Critical issues found: $HIGH_COUNT"
          if [ "$HIGH_COUNT" -gt 0 ]; then
            echo "❌ Bandit found $HIGH_COUNT high/critical issues"
            exit 1
          fi
      
      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-report
          path: bandit-report.json
  
  safety-scan:
    name: Safety Dependency Check
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Safety
        run: pip install safety
      
      - name: Run Safety check
        run: |
          safety check --json --output safety-report.json --continue-on-error
          safety check
      
      - name: Upload Safety report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: safety-report
          path: safety-report.json
  
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
  
  summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [owasp-zap-full-scan, trivy-scan, grype-scan, bandit-scan, safety-scan]
    if: always()
    
    steps:
      - name: Download all reports
        uses: actions/download-artifact@v4
      
      - name: Generate summary
        run: |
          echo "# Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.owasp-zap-full-scan.result }}" == "success" ]; then
            echo "✅ OWASP ZAP Full Scan: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ OWASP ZAP Full Scan: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.trivy-scan.result }}" == "success" ]; then
            echo "✅ Trivy Container Scan: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Trivy Container Scan: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.grype-scan.result }}" == "success" ]; then
            echo "✅ Grype Vulnerability Scan: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Grype Vulnerability Scan: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.bandit-scan.result }}" == "success" ]; then
            echo "✅ Bandit Python Security: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Bandit Python Security: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.safety-scan.result }}" == "success" ]; then
            echo "✅ Safety Dependency Check: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Safety Dependency Check: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Detailed reports available in artifacts." >> $GITHUB_STEP_SUMMARY
