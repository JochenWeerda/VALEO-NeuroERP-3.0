apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "valeo-erp.fullname" . }}-alerts
  labels:
    {{- include "valeo-erp.labels" . | nindent 4 }}
data:
  alerts.yml: |
    groups:
      - name: valeo-erp-alerts
        interval: 30s
        rules:
          # High Error Rate Alert
          - alert: ErrorRateHigh
            expr: rate(api_requests_total{status=~"5.."}[5m]) > 0.05
            for: 5m
            labels:
              severity: critical
              component: api
            annotations:
              summary: "High error rate detected in VALEO-ERP"
              description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%)"
              runbook_url: "https://docs.valeo-erp.com/runbooks/alerts#errorratehigh"
          
          # High Latency Alert
          - alert: LatencyHigh
            expr: histogram_quantile(0.95, rate(api_request_duration_seconds_bucket[5m])) > 0.5
            for: 5m
            labels:
              severity: warning
              component: api
            annotations:
              summary: "High latency detected in VALEO-ERP"
              description: "P95 latency is {{ $value }}s (threshold: 500ms)"
              runbook_url: "https://docs.valeo-erp.com/runbooks/alerts#latencyhigh"
          
          # SSE Disconnect Rate High
          - alert: SSEDisconnectsHigh
            expr: increase(sse_connections_active[5m]) < -10
            for: 5m
            labels:
              severity: warning
              component: sse
            annotations:
              summary: "High SSE disconnect rate"
              description: "More than 10 disconnects in 5 minutes"
              runbook_url: "https://docs.valeo-erp.com/runbooks/alerts#ssedisconnectshigh"
          
          # Database Connection Failures
          - alert: DatabaseDown
            expr: probe_success{job="postgresql"} == 0
            for: 1m
            labels:
              severity: critical
              component: database
            annotations:
              summary: "Database connection failed"
              description: "PostgreSQL is not reachable"
              runbook_url: "https://docs.valeo-erp.com/runbooks/alerts#databasedown"
          
          # Pod Not Ready
          - alert: PodNotReady
            expr: kube_pod_status_ready{namespace="production",pod=~"valeo-erp.*"} == 0
            for: 5m
            labels:
              severity: warning
              component: kubernetes
            annotations:
              summary: "VALEO-ERP pod not ready"
              description: "Pod {{ $labels.pod }} has been not ready for 5 minutes"
          
          # High Memory Usage
          - alert: MemoryUsageHigh
            expr: container_memory_usage_bytes{namespace="production",pod=~"valeo-erp.*"} / container_spec_memory_limit_bytes > 0.9
            for: 5m
            labels:
              severity: warning
              component: resources
            annotations:
              summary: "High memory usage in VALEO-ERP"
              description: "Memory usage is {{ $value | humanizePercentage }} (threshold: 90%)"
          
          # Workflow Transition Failures
          - alert: WorkflowTransitionFailures
            expr: rate(workflow_transitions_total{status="failed"}[5m]) > 0.1
            for: 5m
            labels:
              severity: warning
              component: workflow
            annotations:
              summary: "High workflow transition failure rate"
              description: "{{ $value }} transitions failing per second"
          
          # Auth Failures (Bruteforce-Detection)
          - alert: AuthFailuresHigh
            expr: rate(api_requests_total{endpoint="/api/auth/login",status="401"}[5m]) > 5
            for: 2m
            labels:
              severity: critical
              component: security
            annotations:
              summary: "High authentication failure rate - possible bruteforce attack"
              description: "{{ $value }} failed login attempts per second"
              runbook_url: "https://docs.valeo-erp.com/runbooks/alerts#authfailureshigh"

{{- if .Values.alerts.infrastatEnabled }}
      - name: infrastat-alerts
        interval: 1m
        rules:
          - alert: InfraStatSubmissionFailureRateHigh
            expr: infrastat_submission_failure_ratio > 0.2
            for: 10m
            labels:
              severity: warning
              component: infrastat
            annotations:
              summary: "InfraStat Submission Failure Rate hoch"
              description: "Mehr als 20% der IDEV-Übermittlungen schlagen fehl ({{ $value }})"
          - alert: InfraStatValidationFailures
            expr: rate(infrastat_validation_failure_total[15m]) > 0
            for: 15m
            labels:
              severity: warning
              component: infrastat
            annotations:
              summary: "InfraStat Validation Failures"
              description: "Es treten Validierungsfehler in der ETL-Pipeline auf"
{{- end }}
{{- if .Values.zoll.enabled }}
      - name: zoll-alerts
        interval: 1m
        rules:
          - alert: ZollSanctionsRefreshFailed
            expr: increase(zoll_sanctions_refresh_total{result="failed"}[30m]) > 0
            for: 30m
            labels:
              severity: warning
              component: zoll
            annotations:
              summary: "Zoll-Sanktionsrefresh fehlgeschlagen"
              description: "Mindestens ein Refresh-Versuch schlug in den letzten 30 Minuten fehl"
          - alert: ZollScreeningBlockRateHigh
            expr: rate(zoll_screening_status_total{status="blocked"}[15m]) > 0.1
            for: 15m
            labels:
              severity: critical
              component: zoll
            annotations:
              summary: "Hohe Block-Rate im Screening"
              description: "Mehr als 10% der Vorgänge werden aktuell blockiert"
{{- end }}
      - name: inventory-alerts
        interval: 1m
        rules:
          - alert: InventoryEpcisEventFailures
            expr: increase(inventory_epcis_event_failures_total[10m]) > 0
            for: 10m
            labels:
              severity: warning
              component: inventory
            annotations:
              summary: "EPCIS Event-Fehler erkannt"
              description: "Mindestens ein EPCIS-Event konnte nicht persistiert werden"
          - alert: InventoryEpcisNoEvents
            expr: rate(inventory_epcis_events_total[30m]) == 0
            for: 1h
            labels:
              severity: info
              component: inventory
            annotations:
              summary: "Keine EPCIS-Events beobachtet"
              description: "In den letzten 30 Minuten wurden keine EPCIS-Events erzeugt"

