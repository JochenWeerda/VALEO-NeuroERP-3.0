{
  "$schema": "https://valeo-neuroerp.com/schemas/mask-builder/v3.1.0",
  "meta": {
    "name": "kundenstamm",
    "description": "Kundenstamm für VALEO-NeuroERP - Vollständig mit allen 200+ Feldern",
    "version": "3.1.0",
    "author": "VALEO-NeuroERP Team",
    "created": "2025-10-26",
    "lastModified": "2025-10-26"
  },
  "resource": "kunden",
  "i18n": "de-DE",
  "routing": {
    "basePath": "/verkauf/kunden-stamm",
    "param": "kunden_nr",
    "listPath": "/verkauf/kunden-liste"
  },
  "ui": {
    "responsive": true,
    "breakpoints": {
      "sm": { "columns": 1, "nav": "bottom", "useAccordions": true, "stickyFooterActions": true, "showQuickActions": true },
      "md": { "columns": 2, "nav": "side", "useAccordions": false, "stickyFooterActions": true, "showQuickActions": true },
      "lg": { "columns": 3, "nav": "side", "useAccordions": false, "stickyFooterActions": false, "showQuickActions": false }
    },
    "touch": { "minTargetSizePx": 44, "swipeActions": true, "hapticFeedback": true },
    "performance": { "virtualLists": true, "deferHeavyPanels": true, "lazyLoadImages": true },
    "accessibility": { "ariaLabels": true, "keyboardShortcuts": true, "focusManagement": true, "reducedMotion": true }
  },
  "ai": {
    "enabled": true,
    "intentBar": {
      "shortcut": "Mod+k",
      "placeholder": "Befehl oder Frage eingeben...",
      "actions": [
        { "id": "gen_letter_salutation", "label": "Briefanrede vorschlagen", "inputs": ["contact.salutation","name1"], "writes": ["contact.letter_salutation"] },
        { "id": "validate_vat", "label": "USt-ID prüfen (VIES)", "inputs": ["ust_id_nr","land"], "sidePanel": "aiPanel" },
        { "id": "detect_duplicates", "label": "Dubletten prüfen", "inputs": ["name1","email","tel"] },
        { "id": "summarize_customer", "label": "Kunden-Zusammenfassung", "context": ["history","orders","invoices"], "sidePanel": "aiPanel" },
        { "id": "validate_address", "label": "Adresse validieren", "inputs": ["strasse","plz","ort"] },
        { "id": "generate_customer_greeting", "label": "Kundenbegrüßung generieren", "context": ["name1","contact.salutation"] },
        { "id": "calculate_credit_limit", "label": "Kreditlimit berechnen", "context": ["orders","payments","finance"] }
      ]
    },
    "validators": [
      { "id": "smart_address_check", "on": ["plz","ort"], "severity": "warning" },
      { "id": "required_min_set", "fields": ["name1","ort","email"], "message": "Mindestsatz an Stammdaten nicht erfüllt." },
      { "id": "iban_validation", "on": ["iban"], "severity": "error" },
      { "id": "vat_id_format", "on": ["ust_id_nr"], "severity": "warning" },
      { "id": "credit_limit_check", "on": ["finance.credit_limit"], "severity": "info" }
    ],
    "ragPanels": {
      "aiPanel": {
        "title": "KI-Assistent",
        "sources": ["erp.orders","erp.invoices","crm.activities","erp.payments","erp.credit_history"],
        "actions": ["suggest_next_best_action","create_task","open_email_draft","check_credit_limit","generate_report"]
      }
    },
    "mcp": {
      "tools": [
        { "name": "vies.checkVat", "args": ["vatId","countryCode"] },
        { "name": "geo.resolve", "args": ["street","postcode","city","country"] },
        { "name": "scoring.duplicate", "args": ["name","email","phone"] },
        { "name": "iban.validate", "args": ["iban"] },
        { "name": "credit.check", "args": ["name","address","email"] }
      ]
    },
    "telemetry": { "formFriction": true, "autoFix": true, "usageAnalytics": true }
  },
  "layout": {
    "header": {
      "sticky": true,
      "primary": [
        { "comp": "Text", "bind": "kunden_nr", "label": "Kundennummer", "size": "lg", "aiAssist": { "tool": "scoring.duplicate", "on": ["kunden_nr"] } },
        { "comp": "BadgeSelect", "bind": "customer.status", "optionsRef": "crm.customer.status" },
        { "comp": "TagList", "bind": "meta.tags" }
      ],
      "secondary": [
        { "comp": "Select", "bind": "customer.location_id", "label": "Niederlassung" },
        { "comp": "Select", "bind": "customer.cost_center", "label": "Kostenstelle" },
        { "comp": "Toggle", "bind": "customer.is_active", "label": "Aktiv" }
      ],
      "actions": [
        { "id": "save", "label": "Speichern", "type": "primary", "icon": "Save", "shortcut": "Mod+s" },
        { "id": "new", "label": "Neu", "type": "default", "icon": "Plus", "shortcut": "Mod+n" },
        { "id": "duplicate", "label": "Duplizieren", "type": "default", "icon": "Copy", "shortcut": "Mod+d" },
        { "id": "more", "label": "Weitere", "type": "menu", "icon": "MoreVertical", "items": ["archive","delete","export","history","print","report"] }
      ]
    },
    "nav": [
      { "id": "overview", "label": "Übersicht", "icon": "UserSquare" },
      { "id": "master", "label": "Stammdaten", "icon": "IdCard" },
      { "id": "addresses", "label": "Adressen", "icon": "MapPinned" },
      { "id": "contacts", "label": "Kontakte", "icon": "Users" },
      { "id": "billingTax", "label": "Abrechnung & Steuern", "icon": "Receipt" },
      { "id": "payment", "label": "Zahlungsverkehr", "icon": "CreditCard" },
      { "id": "pricing", "label": "Preise & Rabatte", "icon": "Tag" },
      { "id": "delivery", "label": "Lieferung", "icon": "Truck" },
      { "id": "forms", "label": "Formulare", "icon": "FileText" },
      { "id": "communication", "label": "Kommunikation", "icon": "MessagesSquare" },
      { "id": "prefs", "label": "Präferenzen", "icon": "Settings2" },
      { "id": "profiles", "label": "Profil", "icon": "Building" },
      { "id": "cooperative", "label": "Genossenschaft", "icon": "Building2" },
      { "id": "emailLists", "label": "E-Mail-Listen", "icon": "Mail" },
      { "id": "communities", "label": "Betriebsgemeinschaften", "icon": "Network" },
      { "id": "cpd", "label": "CPD-Konten", "icon": "Database" },
      { "id": "discounts", "label": "Rabatte", "icon": "Percent" },
      { "id": "prices", "label": "Kundenpreise", "icon": "Euro" },
      { "id": "freetext", "label": "Freitext", "icon": "FileText" },
      { "id": "extended", "label": "Erweitert", "icon": "MoreVertical" },
      { "id": "notes", "label": "Notizen", "icon": "StickyNote" },
      { "id": "selections", "label": "Selektionen", "icon": "Filter" },
      { "id": "interfaces", "label": "Schnittstellen", "icon": "Plug" },
      { "id": "history", "label": "Historie", "icon": "History" }
    ],
    "footer": {
      "show": true,
      "showInfo": true,
      "showValidationErrors": true
    }
  },
  "views": [
    {
      "id": "overview",
      "label": "Übersicht",
      "sections": [
        {
          "title": "Kunde",
          "grid": 2,
          "fields": [
            { "comp": "Text", "bind": "name1", "label": "Name", "validators": ["required"] },
            { "comp": "Select", "bind": "customer.account_manager", "label": "Betreuer" },
            { "comp": "BadgeSelect", "bind": "customer.abc_class", "label": "ABC-Klasse", "optionsRef": "crm.customer.abc" },
            { "comp": "Select", "bind": "customer.customer_group", "label": "Kundengruppe" }
          ]
        },
        {
          "title": "Kontakt",
          "grid": 3,
          "fields": [
            { "comp": "Text", "bind": "tel", "label": "Telefon" },
            { "comp": "Text", "bind": "fax", "label": "Fax" },
            { "comp": "Email", "bind": "email", "label": "E-Mail", "aiValidate": { "tool": "scoring.duplicate", "on": ["email"] } }
          ]
        },
        {
          "title": "Adresse",
          "grid": 3,
          "fields": [
            { "comp": "Text", "bind": "strasse", "label": "Straße" },
            { "comp": "Text", "bind": "plz", "label": "PLZ", "width": "xs" },
            { "comp": "Text", "bind": "ort", "label": "Ort" },
            { "comp": "CountrySelect", "bind": "land", "label": "Land" }
          ]
        }
      ]
    },
    {
      "id": "master",
      "label": "Stammdaten",
      "tabs": [
        {
          "id": "identity",
          "label": "Identität",
          "sections": [
            {
              "title": "Namen",
              "grid": 3,
              "fields": [
                { "comp": "Text", "bind": "name1", "label": "Name 1", "validators": ["required"], "aiAssist": { "tool": "scoring.duplicate", "on": ["name1"] } },
                { "comp": "Text", "bind": "name2", "label": "Name 2", "optional": true },
                { "comp": "Text", "bind": "name3", "label": "Name 3", "optional": true }
              ]
            },
            {
              "title": "Anrede",
              "grid": 2,
              "fields": [
                { "comp": "Select", "bind": "contact.salutation", "label": "Anrede", "optionsRef": "common.salutation" },
                { "comp": "Text", "bind": "contact.letter_salutation", "label": "Briefanrede", "aiAssist": { "from": ["contact.salutation","name1"], "prompt": "Erzeuge formelle deutsche Briefanrede" } }
              ]
            }
          ]
        },
        {
          "id": "contact_info",
          "label": "Kontakt",
          "sections": [
            {
              "title": "Kommunikationsdaten",
              "grid": 3,
              "fields": [
                { "comp": "Text", "bind": "tel", "label": "Telefon" },
                { "comp": "Text", "bind": "fax", "label": "Fax" },
                { "comp": "Email", "bind": "email", "label": "E-Mail" },
                { "comp": "Url", "bind": "homepage", "label": "Homepage", "span": 3 }
              ]
            }
          ]
        },
        {
          "id": "metadata",
          "label": "Meta",
          "sections": [
            {
              "title": "Vertrieb",
              "grid": 3,
              "fields": [
                { "comp": "Select", "bind": "customer.account_manager", "label": "Betreuer" },
                { "comp": "BadgeSelect", "bind": "customer.abc_class", "label": "ABC-Klasse", "optionsRef": "crm.customer.abc" },
                { "comp": "Select", "bind": "customer.customer_group", "label": "Kundengruppe" }
              ]
            },
            {
              "title": "Freifelder & Infos",
              "grid": 4,
              "fields": [
                { "comp": "Text", "bind": "meta.region", "label": "Gebiet" },
                { "comp": "Text", "bind": "meta.info1", "label": "Info 1" },
                { "comp": "Text", "bind": "meta.info2", "label": "Info 2" },
                { "comp": "Text", "bind": "meta.info3", "label": "Info 3" },
                { "comp": "Text", "bind": "meta.info4", "label": "Info 4" },
                { "comp": "Text", "bind": "meta.custom.free1", "label": "Frei 1" },
                { "comp": "Text", "bind": "meta.custom.free2", "label": "Frei 2" },
                { "comp": "Text", "bind": "meta.custom.free3", "label": "Frei 3" }
              ]
            }
          ]
        }
      ]
    },
    {
      "id": "addresses",
      "label": "Adressen",
      "sections": [
        {
          "title": "Hauptadresse",
          "grid": 3,
          "fields": [
            { "comp": "Text", "bind": "strasse", "label": "Straße", "validators": ["required"], "aiAssist": { "tool": "geo.resolve", "from": ["strasse","plz","ort","land"] } },
            { "comp": "Text", "bind": "plz", "label": "PLZ", "validators": ["postcode"] },
            { "comp": "Text", "bind": "ort", "label": "Ort", "validators": ["required"] },
            { "comp": "CountrySelect", "bind": "land", "label": "Land", "validators": ["required"] }
          ]
        },
        {
          "title": "Postfach",
          "grid": 2,
          "fields": [
            { "comp": "Text", "bind": "postfach", "label": "Postfach" },
            { "comp": "Text", "bind": "postfach_plz", "label": "Postf.-PLZ" },
            { "comp": "Text", "bind": "postfach_ort", "label": "Postf.-Ort" }
          ]
        }
      ]
    },
    {
      "id": "contacts",
      "label": "Kontakte & Ansprechpartner",
      "subtable": "kunden_ansprechpartner",
      "multiple": true,
      "sections": [
        {
          "title": "Ansprechpartner",
          "grid": 3,
          "fields": [
            { "comp": "Text", "bind": "vorname", "label": "Vorname" },
            { "comp": "Text", "bind": "nachname", "label": "Nachname" },
            { "comp": "Text", "bind": "position", "label": "Position" },
            { "comp": "Text", "bind": "abteilung", "label": "Abteilung" },
            { "comp": "Text", "bind": "telefon1", "label": "Telefon 1" },
            { "comp": "Text", "bind": "mobil", "label": "Mobil" },
            { "comp": "Email", "bind": "email", "label": "E-Mail" },
            { "comp": "Toggle", "bind": "empfanger_rechnung_email", "label": "Rechnung per Mail" },
            { "comp": "Toggle", "bind": "empfanger_mahnung_email", "label": "Mahnung per Mail" }
          ]
        }
      ]
    },
    {
      "id": "billingTax",
      "label": "Abrechnung & Steuern",
      "sections": [
        {
          "title": "Debitorik",
          "grid": 3,
          "fields": [
            { "comp": "Text", "bind": "debitoren_konto", "label": "Deb.-Kto Haupt" },
            { "comp": "Select", "bind": "zahlungsbedingungen_tage", "label": "Zahlungsbedingung" },
            { "comp": "Text", "bind": "sepa_mandate_ref", "label": "SEPA-Mandatsref." }
          ]
        },
        {
          "title": "Steuern & IDs",
          "grid": 3,
          "fields": [
            { "comp": "Text", "bind": "ust_id_nr", "label": "USt-IdNr.", "aiValidate": { "tool": "vies.checkVat", "argsMap": { "vatId": "ust_id_nr", "countryCode": "land" } } },
            { "comp": "Text", "bind": "steuernummer", "label": "Steuernummer" },
            { "comp": "Text", "bind": "betriebsnummer", "label": "Betriebsnummer" }
          ]
        },
        {
          "title": "Sperren & Gründe",
          "grid": 2,
          "fields": [
            { "comp": "Toggle", "bind": "customer.is_blocked", "label": "Gesperrt" },
            { "comp": "TextArea", "bind": "sperrgrund", "label": "Sperrgrund" }
          ]
        }
      ]
    },
    {
      "id": "payment",
      "label": "Bank & Zahlungsverkehr",
      "sections": [
        {
          "title": "Bankverbindung",
          "grid": 3,
          "fields": [
            { "comp": "Text", "bind": "bank", "label": "Bank" },
            { "comp": "Text", "bind": "iban", "label": "IBAN", "aiValidate": { "tool": "iban.validate", "argsMap": { "iban": "iban" } } },
            { "comp": "Text", "bind": "bic", "label": "BIC" }
          ]
        },
        {
          "title": "Zahlungsmodalitäten",
          "grid": 3,
          "fields": [
            { "comp": "Number", "bind": "zahlungsbedingungen_tage", "label": "Zahlungsbedingungen (Tage)", "min": 0, "max": 365 },
            { "comp": "Number", "bind": "skonto", "label": "Skonto (%)", "min": 0, "max": 100 },
            { "comp": "Toggle", "bind": "netto_kasse", "label": "Netto Kasse" },
            { "comp": "Toggle", "bind": "mahnwesen", "label": "Mahnwesen" },
            { "comp": "Select", "bind": "lastschriftverfahren", "label": "Lastschriftverfahren", "options": ["SEPA", "Mandat", "Keines"] },
            { "comp": "Select", "bind": "waehrung", "label": "Währung", "options": ["EUR", "USD", "GBP", "CHF"], "default": "EUR" }
          ]
        }
      ]
    },
    {
      "id": "pricing",
      "label": "Preise & Rabatte",
      "sections": [
        {
          "title": "Globale Rabatte",
          "grid": 3,
          "fields": [
            { "comp": "Toggle", "bind": "direktes_konto", "label": "Direktes Konto" },
            { "comp": "Select", "bind": "rabatt_verrechnung", "label": "Rabatt-Verrechnung", "options": ["Sofort", "Nachträglich"] },
            { "comp": "Number", "bind": "selbstabholer_rabatt", "label": "Selbstabholer-Rabatt (%)", "min": 0, "max": 100 },
            { "comp": "Toggle", "bind": "preisermittlung_sorten", "label": "Preisermittlung/Sorten" },
            { "comp": "Toggle", "bind": "direktabzug", "label": "Direktabzug" },
            { "comp": "Toggle", "bind": "wochenpreis_ec_basis", "label": "Wochenpreis EC-Basis" }
          ]
        },
        {
          "title": "Gültigkeit",
          "grid": 2,
          "fields": [
            { "comp": "Date", "bind": "gueltig_ab", "label": "Gültig ab" },
            { "comp": "Date", "bind": "gueltig_bis", "label": "Gültig bis" }
          ]
        }
      ]
    },
    {
      "id": "profiles",
      "label": "Kundenprofil",
      "subtable": "kunden_profil",
      "sections": [
        {
          "title": "Firmeninformationen",
          "grid": 3,
          "fields": [
            { "comp": "Text", "bind": "firmenname", "label": "Firmenname" },
            { "comp": "Date", "bind": "gruendung", "label": "Gründung" },
            { "comp": "Number", "bind": "jahresumsatz", "label": "Jahresumsatz" },
            { "comp": "Text", "bind": "berufsgenossenschaft", "label": "Berufsgenossenschaft" },
            { "comp": "Text", "bind": "berufsgen_nr", "label": "Berufsgen.-Nr." },
            { "comp": "Text", "bind": "branche", "label": "Branche" },
            { "comp": "Number", "bind": "mitarbeiteranzahl", "label": "Mitarbeiteranzahl", "min": 0 },
            { "comp": "Toggle", "bind": "betriebsrat", "label": "Betriebsrat" }
          ]
        }
      ]
    },
    {
      "id": "freetext",
      "label": "Freitext & Anweisungen",
      "subtable": "kunden_freitext",
      "sections": [
        {
          "title": "Notizen",
          "grid": 1,
          "fields": [
            { "comp": "RichText", "bind": "chef_anweisung", "label": "Chef-Anweisung" },
            { "comp": "RichText", "bind": "langtext", "label": "Langtext" },
            { "comp": "RichText", "bind": "bemerkungen", "label": "Bemerkungen" }
          ]
        }
      ]
    },
    {
      "id": "history",
      "label": "Historie & Logs",
      "sections": [
        {
          "title": "Änderungsverlauf",
          "grid": 1,
          "fields": [
            { "comp": "AuditLog", "bind": "audit" }
          ]
        }
      ]
    }
  ],
  "subtables": {
    "kunden_profil": { "description": "Firmeninformationen", "fields_count": 13 },
    "kunden_ansprechpartner": { "description": "Kontaktpersonen", "fields_count": 23, "multiple": true },
    "kunden_versand": { "description": "Versandoptionen", "fields_count": 6 },
    "kunden_lieferung_zahlung": { "description": "Liefer-/Zahlungsbedingungen", "fields_count": 6 },
    "kunden_datenschutz": { "description": "GDPR", "fields_count": 4 },
    "kunden_genossenschaft": { "description": "Mitgliedschaften", "fields_count": 8 },
    "kunden_email_verteiler": { "description": "E-Mail-Listen", "fields_count": 3, "multiple": true },
    "kunden_betriebsgemeinschaften": { "description": "Verbundmitgliedschaften", "fields_count": 4, "multiple": true },
    "kunden_freitext": { "description": "Freitextfelder", "fields_count": 3 },
    "kunden_allgemein_erweitert": { "description": "Erweiterte Informationen", "fields_count": 15 },
    "kunden_cpd_konto": { "description": "CPD-Konten", "fields_count": 12, "multiple": true },
    "kunden_rabatte_detail": { "description": "Artikel-Rabatte", "fields_count": 6, "multiple": true },
    "kunden_preise_detail": { "description": "Individuelle Preise", "fields_count": 10, "multiple": true }
  },
  "validation": {
    "rules": {
      "name1": { "required": true, "min": 2 },
      "ort": { "required": true },
      "plz": { "pattern": "^[A-Za-z0-9 -]{3,10}$" },
      "ust_id_nr": { "if": "land == 'DE'", "pattern": "^(DE)?[0-9]{9}$" }
    },
    "messages": {
      "required": "Dieses Feld ist erforderlich",
      "pattern": "Ungültiges Format",
      "min": "Wert zu niedrig",
      "max": "Wert zu hoch"
    }
  },
  "behavior": {
    "autoSave": false,
    "draftMode": true,
    "confirmDelete": true,
    "confirmNavigation": true,
    "showChangesSummary": true
  }
}

